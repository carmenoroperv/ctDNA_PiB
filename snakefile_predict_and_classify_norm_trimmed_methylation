####### WILDCARCDS ########
MODELS_BINOMIAL = ["Lasso", "LDA", "Boosting", "SVM_linear", "SVM_poly", "SVM_radial"]
MODELS_MULTINOMIAL = ["Lasso", "LDA", "Boosting"]
CLASSES = ["Bile_Duct_Cancer", "Breast_Cancer", "Colorectal_Cancer", "Gastric_cancer", "Healthy", "Lung_Cancer", "Ovarian_Cancer", "Pancreatic_Cancer"]
PCA  = ["PCA", "Full_data"]

########## INPUT ##########
INPUT_METHYLATION = "data/methylation/methylation_preprocessed_FILTERED.rds"
INPUT_SAMPLE_TYPES = "data/sample_types.txt"
INPUT_PRED_TRAIN = "data/ATAC_predictions_new_split/train_normalized_trimmed_CONTROLS_split.rds" 
INPUT_PRED_TEST_CONTROLS = "data/ATAC_predictions_new_split/test_normalized_trimmed_CONTROLS_split.rds" 
INPUT_PRED_TEST_CASES = "data/cases_controls/cases_controls_rds_format/all_samples_normalized_trimmed_CASES.rds" 

OUTPUT_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_Full_data_{class_type}.rds", model_binomial = MODELS_BINOMIAL, class_type = CLASSES)
OUTPUT_BINOMIAL_PCA = expand("Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_PCA_{class_type}.rds", model_binomial = MODELS_BINOMIAL, class_type = CLASSES)

OUTPUT_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/{model_multinomial}_Predictions_Full_data.rds", model_multinomial = MODELS_MULTINOMIAL)
OUTPUT_MULTINOMIAL_PCA = expand("Classification_output/Methylation/Multinomial_models_output/{model_multinomial}_Predictions_PCA.rds", model_multinomial = MODELS_MULTINOMIAL)


AUCS_CASE_CONTROL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/AUCs_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA) 
ROCS_CASE_CONTROL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/ROC_{model_binomial}__{dataset}.png", model_binomial = MODELS_BINOMIAL, dataset = PCA) 
EVALMETRICS_CASE_CONTROL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/Eval_metrics_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA)
ACCURACY_CASE_CONTROL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/Accuracy_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA)

AUCS_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/AUCs_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA)
ROC_GRIDS_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/ROCgrid_{model_binomial}__{dataset}.png", model_binomial = MODELS_BINOMIAL, dataset = PCA)
ROC_AVG_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/ROCavg_{model_binomial}__{dataset}.png", model_binomial = MODELS_BINOMIAL, dataset = PCA)
EVAL_METRICS_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/Eval_metrics_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA)
ACCURACY_BINOMIAL = expand("Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/Accuracy_{model_binomial}__{dataset}.rds", model_binomial = MODELS_BINOMIAL, dataset = PCA)

AUCS_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/Evaluation/AUCs_{model_multinomial}__{dataset}.rds", model_multinomial = MODELS_MULTINOMIAL, dataset = PCA)
ROC_GRIDS_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/Evaluation/ROCgrid_{model_multinomial}__{dataset}.png", model_multinomial = MODELS_MULTINOMIAL, dataset = PCA) 
ROC_AVG_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/Evaluation/ROCavg_{model_multinomial}__{dataset}.png", model_multinomial = MODELS_MULTINOMIAL, dataset = PCA)
EVAL_METRICS_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/Evaluation/Eval_metrics_{model_multinomial}__{dataset}.rds", model_multinomial = MODELS_MULTINOMIAL, dataset = PCA)
ACCURACY_MULTINOMIAL = expand("Classification_output/Methylation/Multinomial_models_output/Evaluation/Accuracy_{model_multinomial}__{dataset}.rds", model_multinomial = MODELS_MULTINOMIAL, dataset = PCA)

########## RULES ##########

rule all:
    input: AUCS_CASE_CONTROL, ROCS_CASE_CONTROL, EVALMETRICS_CASE_CONTROL, ACCURACY_CASE_CONTROL, AUCS_BINOMIAL, ROC_GRIDS_BINOMIAL, ROC_AVG_BINOMIAL, EVAL_METRICS_BINOMIAL, ACCURACY_BINOMIAL, AUCS_MULTINOMIAL, ROC_GRIDS_MULTINOMIAL, ROC_AVG_MULTINOMIAL, EVAL_METRICS_MULTINOMIAL, ACCURACY_MULTINOMIAL


######################### METHYLATION PREDICTIONS ############################

rule methylation_pred:
    input: 
        input_train = INPUT_PRED_TRAIN,
        input_test_controls = INPUT_PRED_TEST_CONTROLS,
        input_test_cases = INPUT_PRED_TEST_CASES,
        input_target = INPUT_METHYLATION
    output:  
        output_pred = "data/Methylation_predictions_train_20_predict_80/Methylation_pred_lasso_normalized_trimmed.rds",
        output_model = "Trained_models/Methylation_models/train_20_predict_80_models/Lasso_models/lasso_normalized_trimmed.rds"
    conda: 
        "conda_envs/ctDNA.yml" 
    log:
        notebook = "logs/processed_notebooks/train_20_predict_80_methylation/processed_Lasso_reg_TRUE_normalized_trimmed.r.ipynb"  
    notebook: 
        "ATAC_pred_models/Train_20_predict_80_and_cases_models/Lasso_regression/Lasso_reg_TRUE.r.ipynb"


############################### FORMATTING #####################################

rule methylation_format:
    input:
        input = "data/Methylation_predictions_train_20_predict_80/Methylation_pred_lasso_normalized_trimmed.rds"
    output: 
        output_formatted_pred = "data/Methylation_predictions_train_20_predict_80/Methylation_pred_lasso_normalized_trimmed_formatted.rds"
    conda: 
        "conda_envs/ctDNA.yml"
    log: 
        notebook = "logs/processed_notebooks/Methylation_formatting_predictions.r.ipynb"
    notebook: 
        "prep_formatting_normalizing/Format_ATAC_predictions.r.ipynb"
    

############################### STANDARDIZING #####################################

rule methylation_standardize:
    input:
        input_file = "data/Methylation_predictions_train_20_predict_80/Methylation_pred_lasso_normalized_trimmed_formatted.rds"
    output: 
        output_formatted_pred = "data/Methylation_predictions_train_20_predict_80/Full_data_Methylation_pred_lasso_formatted_standardized.rds"
    conda: 
        "conda_envs/ctDNA.yml"
    log: 
        notebook = "logs/processed_notebooks/Methylation_standardizing_predictions.r.ipynb"
    notebook: 
        "prep_formatting_normalizing/Standardizing_ATAC_predictions.r.ipynb"


############################### PCA #####################################

rule methylation_PCA:
    input: 
        input_predictions = "data/Methylation_predictions_train_20_predict_80/Full_data_Methylation_pred_lasso_formatted_standardized.rds"
    output: 
        output_pca = "data/Methylation_predictions_train_20_predict_80/PCA_Methylation_pred_lasso_formatted_standardized.rds"
    threads: 1
    conda: 
        "conda_envs/ctDNA.yml" 
    log: 
        notebook = "logs/processed_notebooks/Methylation_PCA.r.ipynb"
    notebook: 
        "PCA.r.ipynb"

##########################################
#Classification
##########################################

############################### BINOMIAL #####################################

rule methylation_binomial_classification:
    input: 
        input_predictions =  "data/Methylation_predictions_train_20_predict_80/Full_data_Methylation_pred_lasso_formatted_standardized.rds",
        input_sample_types = INPUT_SAMPLE_TYPES
    output: 
        predictions = "Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_Full_data_{class_type}.rds"
    threads: 10
    conda: 
        "conda_envs/ctDNA.yml" 
    params: 
        class_type = "{class_type}"
    script: 
        "Classification/Classification_binomial_all/{wildcards.model_binomial}.R"
        
        
rule methylation_PCA_binomial_classification:
    input: 
        input_predictions =  "data/Methylation_predictions_train_20_predict_80/PCA_Methylation_pred_lasso_formatted_standardized.rds",
        input_sample_types = INPUT_SAMPLE_TYPES
    output: 
        predictions = "Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_PCA_{class_type}.rds"
    threads: 10
    conda: 
        "conda_envs/ctDNA.yml" 
    params: 
        class_type = "{class_type}"
    script: 
        "Classification/Classification_binomial_all/{wildcards.model_binomial}.R"


############################### MULTINOMIAL #####################################

rule methylation_multinomial_classification:
    input: 
        input_predictions = "data/Methylation_predictions_train_20_predict_80/Full_data_Methylation_pred_lasso_formatted_standardized.rds",
        input_sample_types = INPUT_SAMPLE_TYPES
    output: 
        predictions = "Classification_output/Methylation/Multinomial_models_output/{model_multinomial}_Predictions_Full_data.rds"
    threads: 10
    conda: 
        "conda_envs/ctDNA.yml" 
    params: 
        class_type = "{model_multinomial}"
    script: 
        "Classification/Classification_multinomial/{wildcards.model_multinomial}_multinomial.R"

rule methylation_PCA_multinomial_classification:
    input: 
        input_predictions = "data/Methylation_predictions_train_20_predict_80/PCA_Methylation_pred_lasso_formatted_standardized.rds",
        input_sample_types = INPUT_SAMPLE_TYPES
    output: 
        predictions = "Classification_output/Methylation/Multinomial_models_output/{model_multinomial}_Predictions_PCA.rds"
    threads: 10
    conda: 
        "conda_envs/ctDNA.yml" 
    params: 
        class_type = "{model_multinomial}"
    script: 
        "Classification/Classification_multinomial/{wildcards.model_multinomial}_multinomial.R"



rule methylation_get_observed_cancer_types:
    input: 
        input_predictions = "data/Methylation_predictions_train_20_predict_80/Full_data_Methylation_pred_lasso_formatted_standardized.rds",
        input_sample_types = INPUT_SAMPLE_TYPES
    output: 
        observed = "Classification_output/Methylation/Observed_cancer_types.rds"
    threads: 1
    conda: 
        "conda_envs/ctDNA.yml" 
    script: 
        "Classification/get_observed_cancer_types.R"



rule methylation_combine_binomial_cancer_type_predictions:
    input: 
        binomial_pred_full_data = expand("Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_Full_data_{class_type}.rds", model_binomial = MODELS_BINOMIAL, class_type = CLASSES),
        binomial_pred_PCA = expand("Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_PCA_{class_type}.rds", model_binomial = MODELS_BINOMIAL, class_type = CLASSES),
        observed = "Classification_output/Methylation/Observed_cancer_types.rds"
    output: 
        cancer_type_predictions = "Classification_output/Methylation/Binomial_models_output/Combined_cancer_type_predictions/{model_binomial}_cancer_type_Predictions_combined_Full_data.rds",
        cancer_type_predictions_PCA = "Classification_output/Methylation/Binomial_models_output/Combined_cancer_type_predictions/{model_binomial}_cancer_type_Predictions_combined_PCA.rds"
    threads: 1
    conda: 
        "conda_envs/ctDNA.yml" 
    params: 
        model = "{model_binomial}",
        methylation  = "Methylation"
    script: 
        "Classification/combine_binomial_cancer_type_predictions.R"
        

rule methylation_evaluate_classific_case_control:
    input: 
        predictions = "Classification_output/Methylation/Binomial_models_output/{model_binomial}_Predictions_{dataset}_Healthy.rds",
        observed = "Classification_output/Methylation/Observed_cancer_types.rds"
    output: 
        aucs = "Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/AUCs_{model_binomial}__{dataset}.rds", 
        roc = "Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/ROC_{model_binomial}__{dataset}.png", 
        eval_metrics = "Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/Eval_metrics_{model_binomial}__{dataset}.rds",
        accuracy = "Classification_output/Methylation/Binomial_models_output/Evaluation/Case_control/Accuracy_{model_binomial}__{dataset}.rds"
    threads: 1
    params: 
        classification_type = "binomial", 
        model = "{model_binomial}"
    conda: 
        "conda_envs/ctDNA.yml" 
    script: 
        "Classification/AUCs_ROCs_accuracies_case_control.R"


rule methylation_evaluate_classific_binom:
    input: 
        predictions = "Classification_output/Methylation/Binomial_models_output/Combined_cancer_type_predictions/{model_binomial}_cancer_type_Predictions_combined_{dataset}.rds",
        observed = "Classification_output/Methylation/Observed_cancer_types.rds"
    output: 
        aucs = "Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/AUCs_{model_binomial}__{dataset}.rds", 
        roc_grid = "Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/ROCgrid_{model_binomial}__{dataset}.png", 
        roc_avg = "Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/ROCavg_{model_binomial}__{dataset}.png",
        eval_metrics = "Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/Eval_metrics_{model_binomial}__{dataset}.rds",
        accuracy = "Classification_output/Methylation/Binomial_models_output/Evaluation/Cancer_type/Accuracy_{model_binomial}__{dataset}.rds"
    threads: 1
    params: 
        classification_type = "binomial"
    conda: 
        "conda_envs/ctDNA.yml" 
    script: 
        "Classification/AUCs_ROCs_accuracies_cancer_type.R"
        

rule methylation_evaluate_classific_multinom:
    input: 
        predictions = "Classification_output/Methylation/Multinomial_models_output/{model_multinomial}_Predictions_{dataset}.rds",
        observed = "Classification_output/Methylation/Observed_cancer_types.rds"
    output: 
        aucs = "Classification_output/Methylation/Multinomial_models_output/Evaluation/AUCs_{model_multinomial}__{dataset}.rds",
        roc_grid = "Classification_output/Methylation/Multinomial_models_output/Evaluation/ROCgrid_{model_multinomial}__{dataset}.png", 
        roc_avg = "Classification_output/Methylation/Multinomial_models_output/Evaluation/ROCavg_{model_multinomial}__{dataset}.png",
        eval_metrics = "Classification_output/Methylation/Multinomial_models_output/Evaluation/Eval_metrics_{model_multinomial}__{dataset}.rds",
        accuracy = "Classification_output/Methylation/Multinomial_models_output/Evaluation/Accuracy_{model_multinomial}__{dataset}.rds"
    params: 
        classification_type = "multinomial"
    threads: 1
    conda: 
        "conda_envs/ctDNA.yml" 
    script: 
        "Classification/AUCs_ROCs_accuracies_cancer_type.R"